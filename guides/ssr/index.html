<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="Cover the basics of server-side rendering an application with Curi">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Server-Side Rendering Guide | Curi Documentation</title>
    <link href="https://fonts.googleapis.com/css?family=Zilla+Slab:300,400" rel="stylesheet">
    <link href="/static/css/prism.css" rel="stylesheet">
  </head>
  <body>
    <div id="root"><style data-emotion-css="w4dmsu">body{font-family:"Zilla Slab",serif;font-weight:300;font-size:24px;line-height:36px;margin:0;box-sizing:border-box;}@media only screen and (min-width:751px){body{font-size:20px;}}*,*:before,*:after{box-sizing:inherit;}h1,h2,h3,h4,h5,h6{font-weight:normal;margin:5px 0;overflow:hidden;text-overflow:ellipsis;}p{margin:5px 0;word-break:break-word;}h1{font-size:1.75em;line-height:1.5em;}h2{font-size:1.5em;line-height:1.2em;}h3{font-size:1.35em;line-height:1.1em;}h4{font-size:1.2em;line-height:1.1em;}h5{font-size:1.1em;line-height:1.1em;}h6{font-size:1em;line-height:1.1em;}table,th,td{border:1px solid #c7c7c7;border-collapse:collapse;}table{margin-bottom:10px;}th{text-align:left;}th,td{padding:10px;}pre[class*="language-"]{margin:0;background:#222233;}:not(pre) > code[class*="language-"]{white-space:nowrap;}menu{padding:0;margin:0;}</style><style data-emotion-css="137i3vd">.css-137i3vd{display:none;}@media only screen and (min-width:751px){.css-137i3vd{display:block;width:100vw;max-width:100%;background:#222233;padding:0;position:fixed;z-index:1;}.css-137i3vd #home-link{font-size:1.5em;color:#ff9800;}}</style><header class="css-137i3vd e132noc00"><style data-emotion-css="lbfp59">.css-lbfp59{color:#efefef;}.css-lbfp59 li{padding:0 20px 0 0;}.css-lbfp59 li.base > a{color:#efefef;font-size:1.1em;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:50px;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border-bottom:3px solid #222233;padding:0 5px;}.css-lbfp59 li.base > a:hover{color:#ff9800;}.css-lbfp59 li.base > a.active{color:#ff9800;border-bottom-color:#ff9800;}.css-lbfp59 li.base > a.activated{color:#2196f3;border-bottom-color:#2196f3;}.css-lbfp59 a{-webkit-text-decoration:none;text-decoration:none;}</style><nav class="css-lbfp59 e132noc02"><style data-emotion-css="192aemx">.css-192aemx{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-flow:row wrap;-ms-flex-flow:row wrap;flex-flow:row wrap;-webkit-align-items:flex-end;-webkit-box-align:flex-end;-ms-flex-align:flex-end;align-items:flex-end;list-style:none;padding:0;margin:0;max-width:100%;}</style><ul role="menubar" class="css-192aemx e132noc01"><li class="base"><a id="home-link" class=" " href="/">Curi</a></li><li class="base" aria-haspopup="true"><a class="group " href="/v2/">API</a><style data-emotion-css="wvo19q">.css-wvo19q{display:none;position:absolute;left:0;width:100vw;color:#222233;border-bottom:2px solid #222233;}.css-wvo19q.active{display:block;}.css-wvo19q a{color:#222233;-webkit-text-decoration:none;text-decoration:none;}.css-wvo19q a.active{font-weight:bold;}.css-wvo19q ul{list-style:none;margin:0;padding:0;}</style><div class=" css-wvo19q e15ticc50"><style data-emotion-css="1dbx00u">.css-1dbx00u{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-flow:row nowrap;-ms-flex-flow:row nowrap;flex-flow:row nowrap;-webkit-box-pack:start;-webkit-justify-content:flex-start;-ms-flex-pack:start;justify-content:flex-start;background:#deeffe;}.css-1dbx00u > div{margin:0 25px;}</style><ul class="css-1dbx00u e15ticc51"><li><style data-emotion-css="ermd9y">.css-ermd9y{margin:0 25px;}</style><menu class="css-ermd9y e1m8q8pb0"><h3>router</h3><ul class="link-list"><li class="solo"><a class=" " href="/v2/@curi/router/">router</a></li><li class="solo"><a class=" " href="/v2/@curi/interactions/">interactions</a></li></ul></menu></li><li><menu class="css-ermd9y e1m8q8pb0"><h3>render</h3><ul class="link-list"><li class="solo"><a class=" " href="/v2/@curi/react-dom/">react-dom</a></li><li class="solo"><a class=" " href="/v2/@curi/react-native/">react-native</a></li><li class="solo"><a class=" " href="/v2/@curi/svelte/">svelte</a></li><li class="solo"><a class=" " href="/v2/@curi/vue/">vue</a></li></ul></menu></li><li><menu class="css-ermd9y e1m8q8pb0"><h3>other</h3><ul class="link-list"><li class="solo"><a class=" " href="/v2/@curi/static/">static</a></li><li class="solo"><a class=" " href="/v2/@curi/helpers/">helpers</a></li><li class="solo"><a class=" " href="/v2/@curi/types/">types</a></li></ul></menu></li></ul></div></li><li class="base" aria-haspopup="true"><a class="group active" href="/guides/">Guides</a><div class=" css-wvo19q e15ticc50"><ul class="css-1dbx00u e15ticc51"><menu class="css-ermd9y e1m8q8pb0"><h3>basic</h3><ul class="link-list"><li class="solo"><a class=" " href="/guides/installation/">Installation</a></li><li class="solo"><a class=" " href="/guides/getting-started/">Getting Started</a></li><li class="solo"><a class=" " href="/guides/history/">History</a></li><li class="solo"><a class=" " href="/guides/routes/">Routes</a></li><li class="solo"><a class=" " href="/guides/responses/">Responses</a></li><li class="solo"><a class=" " href="/guides/navigation-objects/">Navigation Objects</a></li><li class="solo"><a class=" " href="/guides/sync-or-async/">Sync or Async</a></li><li class="solo"><a class=" " href="/guides/new-responses/">New Responses</a></li><li class="solo"><a class=" " href="/guides/accessibility/">Accessibility</a></li></ul></menu><menu class="css-ermd9y e1m8q8pb0"><h3>rendering</h3><ul class="link-list"><li class="solo"><a class=" " href="/guides/react-dom/">React DOM</a></li><li class="solo"><a class=" " href="/guides/react-native/">React Native</a></li><li class="solo"><a class=" " href="/guides/svelte/">Svelte</a></li><li class="solo"><a class=" " href="/guides/vue/">Vue</a></li></ul></menu><menu class="css-ermd9y e1m8q8pb0"><h3>advanced</h3><ul class="link-list"><li class="solo"><a class=" " href="/guides/route-interactions/">Route Interactions</a></li><li class="solo"><a class=" " href="/guides/side-effects/">Side Effects</a></li><li class="solo"><a class=" " href="/guides/code-splitting/">Code Splitting</a></li><li class="solo"><a class=" " href="/guides/loading/">Loading Route Data</a></li><li class="solo"><a class=" active" href="/guides/ssr/">Server-Side Rendering</a></li><li class="solo"><a class=" " href="/guides/apollo/">Apollo Integration</a></li></ul></menu></ul></div></li><li class="base" aria-haspopup="true"><a class="group " href="/tutorial/">Tutorials</a><div class=" css-wvo19q e15ticc50"><ul class="css-1dbx00u e15ticc51"><menu class="css-ermd9y e1m8q8pb0"><h3>Basic</h3><ul class="link-list"><li class="solo"><a class=" " href="/tutorial/react-basics/">React Basics</a></li><li class="solo"><a class=" " href="/tutorial/vue-basics/">Vue Basics</a></li></ul></menu><menu class="css-ermd9y e1m8q8pb0"><h3>Advanced</h3><ul class="link-list"><li class="solo"><a class=" " href="/tutorial/react-advanced/">React Advanced</a></li></ul></menu></ul></div></li><li class="base" aria-haspopup="true"><a class="group " href="/examples/">Examples</a><div class=" css-wvo19q e15ticc50"><ul class="css-1dbx00u e15ticc51"><menu class="css-ermd9y e1m8q8pb0"><ul class="link-list" style="margin:0 25px"><li class="solo"><a class=" " href="/examples/basic/">Basic</a></li><li class="solo"><a class=" " href="/examples/accessibility/">Focus Management</a></li><li class="solo"><a class=" " href="/examples/active/">Active Routes</a></li><li class="solo"><a class=" " href="/examples/async/">Async Routes &amp; Navigation</a></li><li class="solo"><a class=" " href="/examples/breadcrumbs/">Breadcrumbs</a></li><li class="solo"><a class=" " href="/examples/redirects/">Redirects</a></li><li class="solo"><a class=" " href="/examples/multi-body/">Multiple Body Components</a></li><li class="solo"><a class=" " href="/examples/transitions/">Route Transitions</a></li><li class="solo"><a class=" " href="/examples/modal/">Modal Content</a></li><li class="solo"><a class=" " href="/examples/spotify/">Spotify Clone</a></li><li class="solo"><a class=" " href="/examples/twitch/">Twitch Clone</a></li><li class="solo"><a class=" " href="/examples/code-splitting/">Code Splitting</a></li><li class="solo"><a class=" " href="/examples/script-tags/">Script Tags</a></li><li class="solo"><a class=" " href="/examples/server-rendering/">Server Rendering</a></li><li class="solo"><a class=" " href="/examples/side-effects/">Side Effects</a></li></ul></menu></ul></div></li><li class="base"><a href="https://github.com/pshrmn/curi">GitHub</a></li></ul></nav></header><style data-emotion-css="1y5vav3">.css-1y5vav3{position:fixed;width:100vw;height:40px;left:0;bottom:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-flow:row nowrap;-ms-flex-flow:row nowrap;flex-flow:row nowrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;z-index:9999;}</style><menu class="css-1y5vav3 e18ecyrg1"><style data-emotion-css="x8eihf">.css-x8eihf{height:40px;border:0;font-size:1em;font-family:"Zilla Slab",serif;-webkit-flex:1;-ms-flex:1;flex:1;background:#c8e6c9;}.css-x8eihf.active{background:#ef9a9a;}@media only screen and (min-width:751px){.css-x8eihf{display:none;}}</style><button class="false main css-x8eihf e1105ass0">Menu</button></menu><style data-emotion-css="7kugt2">.css-7kugt2{position:fixed;overflow-y:scroll;width:100vw;height:100vh;background:#efefef;z-index:999;padding:0 0 45px 0;}.css-7kugt2.visible{display:block;}.css-7kugt2 ul{margin:3px 0;padding-left:0px;list-style:none;}.css-7kugt2 li{margin:3px 0;}.css-7kugt2 a{-webkit-text-decoration:none;text-decoration:none;display:inline-block;color:#222233;}.css-7kugt2 h3{border-bottom:1px solid #333;}.css-7kugt2 .active{font-weight:bold;}.css-7kugt2 .children{display:none;background:#efefef;padding:10px;}.css-7kugt2 .children.visible{display:block;position:fixed;top:0;bottom:0;left:0;right:0;overflow-y:scroll;}@media only screen and (min-width:751px){.css-7kugt2{display:none;}.css-7kugt2.visible{display:none;}}</style><menu hidden="" class=" css-7kugt2 e18ecyrg0"><style data-emotion-css="y5qusc">.css-y5qusc [data-reach-tab-panel]{outline:none;}.css-y5qusc [data-reach-tab-list]{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;background:hsla(0,0%,0%,0.05);}.css-y5qusc [data-reach-tab]{display:inline-block;border:none;padding:0.25em 0.5em;margin:0;background:none;color:inherit;font:inherit;cursor:pointer;-webkit-appearance:none;-moz-appearance:none;border-bottom:solid 1px transparent;}.css-y5qusc [data-reach-tab]:active{background:hsla(0,0%,0%,0.05);}.css-y5qusc [data-reach-tab]:disabled{opacity:0.25;cursor:default;}.css-y5qusc [data-reach-tab][data-selected]{border-bottom-color:inherit;}</style><div data-reach-tabs="" class="css-y5qusc e1ytk3540"><div data-reach-tab-list="" role="tablist"><button data-reach-tab="" role="tab" id="tab:null:0" tabindex="0" aria-selected="true" aria-controls="panel:null:0" data-selected="">Main</button><button data-reach-tab="" role="tab" id="tab:null:1" tabindex="-1" aria-selected="false" aria-controls="panel:null:1">Page</button></div><style data-emotion-css="1aoqav5">.css-1aoqav5{padding:0 15px;}</style><div data-reach-tab-panels="" class="css-1aoqav5 e1ytk3541"><div data-reach-tab-panel="" role="tabpanel" tabindex="-1" aria-labelledby="tab:null:0" id="panel:null:0"><ul><li><a class="home-link " href="/">Curi</a></li><li><style data-emotion-css="eh8tip">.css-eh8tip a{color:#222233;}.css-eh8tip ul{margin-left:10px;}.css-eh8tip > li{margin-bottom:15px;}</style><ul class="css-eh8tip e11f272a0"><li><style data-emotion-css="12lsm47">.css-12lsm47{cursor:pointer;font-size:24px;font-family:"Zilla Slab",serif;text-align:left;width:100%;background:none;border:0;padding:0;color:#222233;}</style><button title="Toggle group visibility" class="css-12lsm47 e11f272a1"><svg width="25" height="15" viewBox="0 0 25 15" xmlns="http://www.w3.org/2000/svg"><path d="M2,5 l5,5 l5,-5" fill="none" stroke="black" stroke-width="3"></path></svg>API</button></li></ul></li><li><ul class="css-eh8tip e11f272a0"><li><button title="Toggle group visibility" class="css-12lsm47 e11f272a1"><svg width="25" height="15" viewBox="0 0 25 15" xmlns="http://www.w3.org/2000/svg"><path d="M2,5 l5,5 l5,-5" fill="none" stroke="black" stroke-width="3"></path></svg>Guides</button></li></ul></li><li><ul class="css-eh8tip e11f272a0"><li><button title="Toggle group visibility" class="css-12lsm47 e11f272a1"><svg width="25" height="15" viewBox="0 0 25 15" xmlns="http://www.w3.org/2000/svg"><path d="M2,5 l5,5 l5,-5" fill="none" stroke="black" stroke-width="3"></path></svg>Tutorials</button></li></ul></li><li><ul class="css-eh8tip e11f272a0"><li><button title="Toggle group visibility" class="css-12lsm47 e11f272a1"><svg width="25" height="15" viewBox="0 0 25 15" xmlns="http://www.w3.org/2000/svg"><path d="M2,5 l5,5 l5,-5" fill="none" stroke="black" stroke-width="3"></path></svg>Examples</button></li></ul></li><li><a href="https://github.com/pshrmn/curi">GitHub</a></li></ul></div><div data-reach-tab-panel="" role="tabpanel" tabindex="-1" aria-labelledby="tab:null:1" hidden="" id="panel:null:1"><style data-emotion-css="gnbpx8">.css-gnbpx8{width:200px;padding:0;margin:0;}.css-gnbpx8 p{margin:0;}.css-gnbpx8 a{-webkit-text-decoration:none;text-decoration:none;display:block;}.css-gnbpx8 ol{padding-left:0;margin-top:0;list-style-type:none;}.css-gnbpx8 ol ol{padding-left:15px;font-size:0.9em;}</style><menu class="css-gnbpx8 e1evhjzy0"><ol><li><a href="#reuse">Reusing Code</a></li><li><a href="#framework">Web Framework</a></li><li><a href="#request-matching">Request Matching</a><ol><li><a href="#client-side-routes">Client-Side Routes</a></li><li><a href="#static-assets">Static Assets</a></li><li><a href="#path-order">Path Order</a></li></ol></li><li><a href="#handler">Render Handler</a></li><li><a href="#router">Router</a><ol><li><a href="#history">History</a></li><li><a href="#routes">Routes</a></li></ol></li><li><a href="#handling-response">Handling the Response</a><ol><li><a href="#redirect-responses">Redirect Responses</a></li></ol></li></ol></menu></div></div></div></menu><style data-emotion-css="13rb4cr">.css-13rb4cr{width:100vw;max-width:100%;padding:10px 10px 0;margin-bottom:45px;}.css-13rb4cr a{color:#222233;}@media only screen and (min-width:751px){.css-13rb4cr{padding:50px 0 0;margin-bottom:0;}}</style><main tabindex="-1" style="outline:none" class="css-13rb4cr e1fl12nk0"><style data-emotion-css="csv88t">.css-csv88t{position:relative;}@media only screen and (min-width:751px){.css-csv88t{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-flow:row nowrap;-ms-flex-flow:row nowrap;flex-flow:row nowrap;}}@media only screen and (min-width:751px){.css-csv88t{max-width:100vw;}}</style><div class="css-csv88t e1hcridg0"><style data-emotion-css="q1fc1d">@media only screen and (min-width:751px){.css-q1fc1d{margin-left:275px;}}</style><article class="css-q1fc1d e1hcridg1"><style data-emotion-css="gmhjbe">.css-gmhjbe{margin-top:15px;}.css-gmhjbe p{margin:0 0 25px;font-size:0.8em;}@media only screen and (min-width:751px){.css-gmhjbe{max-width:751px;}.css-gmhjbe p{font-size:1em;}.css-gmhjbe.centered{margin:0 auto;}}</style><section class="section css-gmhjbe"><h1 tabindex="-1" style="outline:none">Server-Side Rendering</h1><p>Server-side rendering (SSR) is used to generate the HTML for pages when the server receives a request for them. While not strictly necessary for single-page applications, server-side rendering can potentially be beneficial by:</p><ol><li>Speeding up the initial render time.</li><li>Making it easier for web crawlers to view the application&#x27;s content (which <em>may</em> improve SEO).</li></ol><p>This guide will cover how to setup server-side rendering and some of the issues that you may run into.</p></section><section class="css-gmhjbe e1a46ijo0"><style data-emotion-css="1gka4o8">.css-1gka4o8 .header-link{-webkit-text-decoration:none;text-decoration:none;}.css-1gka4o8 .header-link::after{content:"#";color:#333;margin-left:5px;}@media only screen and (min-width:751px){.css-1gka4o8{margin-top:-50px;padding-top:50px;}.css-1gka4o8 .header-link::after{display:none;}.css-1gka4o8 .header-link:hover::after{display:inline-block;}}</style><h2 id="reuse" tabindex="-1" style="outline:none" class="css-1gka4o8"><a class="header-link" href="#reuse">Reusing Code</a></h2><p>Being able to reuse code on the client and server is one of the benefits of JavaScript. If you are using syntax in your client-side code that Node doesn&#x27;t know how to parse, such as import/export or JSX, you may run into issues.</p><p>The <a href="https://babeljs.io/">Babel</a> package<!-- --> <style data-emotion-css="jo5c25">.css-jo5c25{padding:0.1em;border-radius:0.3em;white-space:normal;background:#fff;color:#222233;text-shadow:none;white-space:wrap;}.css-jo5c25 .token{color:#222233;}</style><code class="inline-code css-jo5c25 eutm4hs0">@babel/node</code> lets Babel compile your code on the fly to syntax that Node understands. Anywhere that you would call<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">node &lt;command&gt;</code>, you should call<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">babel-node &lt;command&gt;</code> instead.</p><style data-emotion-css="xg7t84">.css-xg7t84{width:100%;margin:0 0 25px;font-size:0.8em;}.css-xg7t84 pre{white-space:pre-wrap;height:100%;vertical-align:top;}@media only screen and (min-width:751px){.css-xg7t84{font-size:1em;}.css-xg7t84 code{min-width:200px;white-space:pre-wrap;}}</style><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-bash">npm install --save-dev @babel/node</code></pre></figure><style data-emotion-css="1op01r7">.css-1op01r7{padding:10px 5px;margin:5px 0;border:1px solid #c7c7c7;background:#ffe8bf;border-color:#ff9800;}.css-1op01r7 p:last-child{margin-bottom:0;}.css-1op01r7 .inline-code{background:#ffb74d !important;}</style><aside class="css-1op01r7 e1bjkffy1"><strong>Warning:</strong> <p><code class="inline-code css-jo5c25 eutm4hs0">@babel/node</code> should only be used in development. For production, the server&#x27;s modules should be pre-compiled (using Babel).</p></aside></section><section class="css-gmhjbe e1a46ijo0"><h2 id="framework" tabindex="-1" style="outline:none" class="css-1gka4o8"><a class="header-link" href="#framework">Web Framework</a></h2><p>In order to render JavaScript on the server, you will need to use Node. This guide will be using the<!-- --> <a href="https://expressjs.com/">Express</a> web framework.</p><style data-emotion-css="10wffac">.css-10wffac{padding:10px 5px;margin:5px 0;border:1px solid #c7c7c7;background:#eeeeee;}.css-10wffac p:last-child{margin-bottom:0;}.css-10wffac .inline-code{background:#fff !important;}</style><aside class="css-10wffac e1bjkffy0"><strong>Note:</strong> <p>There are ways to mix Node server-side rendering with non-Node frameworks, but that is outside the scope of this guide.</p></aside><p>Familiarity with Express is not expected, so to get you started, this guide will provide some code snippets for a basic setup.</p><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-bash">npm install express</code></pre></figure><p>The server&#x27;s setup code can be placed anywhere, but we will follow Node&#x27;s convention and save it in a <code class="inline-code css-jo5c25 eutm4hs0">server.js</code> file.</p><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-javascript">// server.js
const express = require(&quot;express&quot;);

const app = express();

// ...

app.listen(&quot;8080&quot;, () =&gt; {
  console.log(&quot;Server is running.&quot;);
});</code></pre></figure><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-bash"># tell node to start the server
# (development only!)
babel-node server.js</code></pre></figure><p>With the server ready to go, we can start configuring it to render a single-page application.</p></section><section class="css-gmhjbe e1a46ijo0"><h2 id="request-matching" tabindex="-1" style="outline:none" class="css-1gka4o8"><a class="header-link" href="#request-matching">Request Matching</a></h2><p>A web framework receives requests from the client and returns responses.</p><p>In the client-side application, we define the routes that are valid for the application. Similarly, the server needs to define which request paths are valid so that it can properly respond to them.</p><p>Server paths are given handler functions. These can do a variety of things, but we will only be using them to send responses.</p><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-javascript">app.use(&quot;/hi&quot;, function(req, res) {
  res.send(&quot;Hey!&quot;);
})</code></pre></figure><section class="css-gmhjbe e1a46ijo0"><h3 id="client-side-routes" tabindex="-1" style="outline:none" class="css-1gka4o8"><a class="header-link" href="#client-side-routes">Client-Side Routes</a></h3><p>Instead of telling the server about every single valid client-side route, a wildcard path is used to match every request. Determining what to render for the request will be done by Curi.</p><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-javascript">// the wildcard matches every GET request
app.get(&quot;*&quot;, renderHandler);</code></pre></figure><aside class="css-10wffac e1bjkffy0"><strong>Note:</strong> <p>The <code class="inline-code css-jo5c25 eutm4hs0">*</code> wildcard handler is similar to the Curi path<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">(.*)</code>. Express and Curi both use<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">path-to-regexp</code> for path matching. However, Express uses an old version. <code class="inline-code css-jo5c25 eutm4hs0">path-to-regexp</code> removed support for the barebones <code class="inline-code css-jo5c25 eutm4hs0">*</code> pattern in the version that Curi uses, which is why we have to use <code class="inline-code css-jo5c25 eutm4hs0">(.*)</code> in Curi routes.</p></aside></section><section class="css-gmhjbe e1a46ijo0"><h3 id="static-assets" tabindex="-1" style="outline:none" class="css-1gka4o8"><a class="header-link" href="#static-assets">Static Assets</a></h3><p>Page requests aren&#x27;t the only requests that the framework will handle. Requests for static resources, like scripts, stylesheet, and images shouldn&#x27;t be handled by Curi. Express provides a<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">static</code> method to map request locations &quot;real&quot; (files exist on the server) locations.</p><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-javascript">app.use(&quot;/static&quot;, express.static());</code></pre></figure><p>Using the above static file handler, all static file requests in HTML/JavaScript should begin with <code class="inline-code css-jo5c25 eutm4hs0">/static</code>.</p><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-html">&lt;img src=&quot;/static/img/circle.png&quot; /&gt;</code></pre></figure></section><section class="css-gmhjbe e1a46ijo0"><h3 id="path-order" tabindex="-1" style="outline:none" class="css-1gka4o8"><a class="header-link" href="#path-order">Path Order</a></h3><p>Express matches against paths in the order that they are registered, so the static files path needs to be defined before the wildcard path.</p><p>Any other non-page paths, like APIs, would also need to be defined before the catch-all.</p><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-javascript">app.use(&quot;/static&quot;, express.static());
app.use(&quot;/api&quot;, dataHandler);
app.get(&quot;*&quot;, renderHandler);</code></pre></figure></section></section><section class="css-gmhjbe e1a46ijo0"><h2 id="handler" tabindex="-1" style="outline:none" class="css-1gka4o8"><a class="header-link" href="#handler">Render Handler</a></h2><p>The render handler function receives the request object and a response object. The response object is used to build and send a response to the user.</p><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-javascript">// renderer.js
function renderHandler(req, res) {

}

// server.js
const renderHandler = require(&quot;./renderer&quot;);

app.get(&quot;*&quot;, renderHandler)</code></pre></figure><aside class="css-10wffac e1bjkffy0"><strong>Note:</strong> <p>If you are setting up a server without server-side rendering, the<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">renderHandler</code> function could use <code class="inline-code css-jo5c25 eutm4hs0">res.sendFile</code> <!-- -->to return a universal HTML file for every route.</p></aside><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-javascript">const index = path.join(__dirname, &quot;public&quot;, &quot;index.html&quot;);

function renderHandler(req, res) {
  res.sendFile(index);
}</code></pre></figure></section><section class="css-gmhjbe e1a46ijo0"><h2 id="router" tabindex="-1" style="outline:none" class="css-1gka4o8"><a class="header-link" href="#router">Router</a></h2><p>A router instance will be created for every single request. The router will match the requested location to its routes and generate a response, which can be used to render the HTML.</p><p>Curi has two optimizations to make this more efficient:</p><ol><li>By wrapping the routes array in a <code class="inline-code css-jo5c25 eutm4hs0">prepareRoutes</code> call, all of an application&#x27;s routes are pre-compiled. Without<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">prepareRoutes</code>, the route pathes would need to be re-compiled for every request!</li><li>We will use a lightweight history type created specifically for server-side rendering.</li></ol><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-javascript">// renderer.js
import { createRouter } from &quot;@curi/router&quot;;
import { createReusable } from &quot;@hickory/in-memory&quot;;

const reusable = createReusable();

function handler(req, res) {
  const router = createRouter(reusable, routes, {
    history: { location: req.url }
  });
  router.once(({ response }) =&gt; {
    // render the response
  })
}</code></pre></figure><section class="css-gmhjbe e1a46ijo0"><h3 id="history" tabindex="-1" style="outline:none" class="css-1gka4o8"><a class="header-link" href="#history">History</a></h3><p>On the client-side, a single-page application uses<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">@hickory/browser</code> to create a history instance. However, that uses browser only APIs. On the server, the<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">@hickory/in-memory</code> package is used to create a history instance that only exists in memory.</p><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-bash">npm install @hickory/in-memory</code></pre></figure><p>The server doesn&#x27;t need a fully functional history object. Instead, the server only needs a history object that knows its location and how to generate URLs.</p><p>The <code class="inline-code css-jo5c25 eutm4hs0">createReusable</code> function exported by<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">@hickory/in-memory</code> is made specifically for this job.<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">createReusable</code> takes history options and returns a history function.</p><p><code class="inline-code css-jo5c25 eutm4hs0">createReusable</code> creates internal functions for location parsing/stringifying ahead of time so that they don&#x27;t need to be recreated for every request.</p><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-javascript">// handler.js
import { createRouter } from &quot;@curi/router&quot;;
import { createReusable } from &quot;@hickory/in-memory&quot;;

const reusable = createReusable();</code></pre></figure><p>When creating the router, we must pass a <code class="inline-code css-jo5c25 eutm4hs0">history</code> option with the location of the request.</p><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-javascript">function handler(req, res) {
  const router = createRouter(reusable, routes, {
    history: { location: req.url }
  });
  // ...
}</code></pre></figure></section><section class="css-gmhjbe e1a46ijo0"><h3 id="routes" tabindex="-1" style="outline:none" class="css-1gka4o8"><a class="header-link" href="#routes">Routes</a></h3><p>As stated above, the <code class="inline-code css-jo5c25 eutm4hs0">prepareRoutes</code> function is used to pre-compile routes, which means that they don&#x27;t end up being re-compiled for every single request. If all of an application&#x27;s routes are synchronous (they don&#x27;t use <code class="inline-code css-jo5c25 eutm4hs0">route.resolve</code>), then they don&#x27;t need to do anything else for server-side rendering.</p><p>Ideally, you will be able to re-use your client side routes on the server, but if the client routes use browser only APIs, you may need to adapt the routes to work on the server.</p><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-javascript">// handler.js
import routes from &quot;../client/routes&quot;;</code></pre></figure><p>One approach to client/server routes is to keep two copies: one for the client and one for the server. However, this should be a last resort because it can lead to inconsistencies if you update one file but not the other.</p><p>A more reusable approach would be to use &quot;universal&quot; wrappers around any environment specific APIs. For example, the<!-- --> <a href="https://github.com/matthew-andrews/isomorphic-fetch"><code class="inline-code css-jo5c25 eutm4hs0">isomorphic-fetch</code></a> <!-- -->package could be used to support <code class="inline-code css-jo5c25 eutm4hs0">fetch</code> in the browser and Node.</p><figure class="css-xg7t84 e12etsbl0"><pre><code class="language-javascript">// routes.js
import fetch from &quot;isomorphic-fetch&quot;;
import { prepareRoutes } from &quot;@curi/router&quot;;

export default prepareRoutes([
  {
    name: &quot;Test&quot;,
    path: &quot;test&quot;,
    resolve() {
      return fetch(&quot;/test-data&quot;);
    }
  }
]);</code></pre></figure></section></section><section class="css-gmhjbe e1a46ijo0"><h2 id="handling-response" tabindex="-1" style="outline:none" class="css-1gka4o8"><a class="header-link" href="#handling-response">Handling the Response</a></h2><p>When the router is created, it will start generating a response by matching its <code class="inline-code css-jo5c25 eutm4hs0">history</code> object&#x27;s current location. If the application has any asynchronous routes, the <code class="inline-code css-jo5c25 eutm4hs0">response</code> may not be ready immediately. The safest approach is to use<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">router.once</code> to wait for the <code class="inline-code css-jo5c25 eutm4hs0">response</code>.</p><figure class="css-xg7t84 e12etsbl0"><pre data-line="5-7"><code class="language-javascript">function renderHandler(req, res) {
  const router = createRouter(reusable, routes, {
    history: { location: req.url }
  });
  router.once(({ response }) =&gt; {
    // ...
  });
}</code></pre></figure><p>Once the response is generated, we are ready to render. This step will generate the HTML string for the application. How exactly you do this depends on what UI renderer you are using, but the process is approximately the same for most renderering libraries.</p><p>Here, we will assume that you are using React. The<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">react-dom/server</code> module provides a<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">renderToString</code> method, which will render an application as a string.</p><p>Rendering with React on the server is essentially the same as rendering on the client. We create a <code class="inline-code css-jo5c25 eutm4hs0">Router</code> and use<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">renderToString</code> (instead of <code class="inline-code css-jo5c25 eutm4hs0">ReactDOM.render</code>) to render the component.</p><figure class="css-xg7t84 e12etsbl0"><pre data-line="1-2,9-14"><code class="language-javascript">import { renderToString } from &quot;react-dom/server&quot;;
import { createRouterComponent } from &quot;@curi/react-dom&quot;;

function renderHandler(req, res) {
  const router = createRouter(reusable, routes, {
    history: { location: req.url }
  });
  router.once(({ response }) =&gt; {
    const Router = createRouterComponent(router);
    const markup = renderToString(
      &lt;Router&gt;
        &lt;App /&gt;
      &lt;/Router&gt;
    );
  });
}</code></pre></figure><p>Rendering with <code class="inline-code css-jo5c25 eutm4hs0">renderToString</code> only generates an HTML string for the application. We are missing the <code class="inline-code css-jo5c25 eutm4hs0">&lt;<!-- -->html<!-- -->&gt;</code>,<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">&lt;<!-- -->head<!-- -->&gt;</code>,<code class="inline-code css-jo5c25 eutm4hs0">&lt;<!-- -->body<!-- -->&gt;</code>, <code class="inline-code css-jo5c25 eutm4hs0">&lt;<!-- -->script<!-- -->&gt;</code>, etc. tags that are required for the full HTML page to properly function.</p><p>We can write a function that takes the string created by<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">renderToString</code>and inserts it into the full HTML string for a page.</p><p>For a React application, the markup string should be set as the child of its container element. If you render into the <code class="inline-code css-jo5c25 eutm4hs0">#root</code> <!-- -->element on the client, the HTML should have a <code class="inline-code css-jo5c25 eutm4hs0">#root</code> <!-- -->element.</p><p>Any JavaScript scripts that need to be rendered should also be included in the HTML. Make sure that their paths are absolute; if the path is relative, then you will run into errors resolving the location for nested routes!</p><p>The <code class="inline-code css-jo5c25 eutm4hs0">meta</code> property of a <code class="inline-code css-jo5c25 eutm4hs0">response</code> is useful for server-side rendering. For example, routes can set<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">meta.title</code> to be the page&#x27;s title, which can be inserted into the generated HTML.</p><figure class="css-xg7t84 e12etsbl0"><pre data-line="4-15,28-29"><code class="language-javascript">import { renderToString } from &quot;react-dom/server&quot;;
import { createRouterComponent } from &quot;@curi/react-dom&quot;;

function insertMarkup(markup, title) {
  return `&lt;!doctype html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;${title} | My Site&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;root&quot;&gt;${markup}&lt;/div&gt;
    &lt;script src=&quot;/static/js/bundle.js&quot;&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;`;
}

function renderHandler(req, res) {
  const router = createRouter(reusable, routes, {
    history: { location: req.url }
  });
  router.once(({ response }) =&gt; {
    const Router = createRouterComponent(router);
    const markup = renderToString(
      &lt;Router&gt;
        &lt;App /&gt;
      &lt;/Router&gt;
    );
    const html = insertMarkup(markup, response.meta.title);
    res.send(html);
  });
}</code></pre></figure><aside class="css-10wffac e1bjkffy0"><strong>Note:</strong> <p>If you server render a React application, you should use<!-- --> <code class="inline-code css-jo5c25 eutm4hs0">ReactDOM.hydrate</code> instead of <code class="inline-code css-jo5c25 eutm4hs0">ReactDOM.render</code> on the client.</p></aside><section class="css-gmhjbe e1a46ijo0"><h3 id="redirect-responses" tabindex="-1" style="outline:none" class="css-1gka4o8"><a class="header-link" href="#redirect-responses">Redirect Responses</a></h3><p>If a route matches and it redirects, you can handle it without rendering the application. A <code class="inline-code css-jo5c25 eutm4hs0">response</code> is a redirect if it has a <code class="inline-code css-jo5c25 eutm4hs0">redirect</code> property. <code class="inline-code css-jo5c25 eutm4hs0">redirect.url</code> is that full URL (<code class="inline-code css-jo5c25 eutm4hs0">pathname</code>, <code class="inline-code css-jo5c25 eutm4hs0">query</code>, and <code class="inline-code css-jo5c25 eutm4hs0">hash</code>).</p><figure class="css-xg7t84 e12etsbl0"><pre data-line="9-12"><code class="language-javascript">import { renderToString } from &quot;react-dom/server&quot;;
import { createRouterComponent } from &quot;@curi/react-dom&quot;;

function renderHandler(req, res) {
  const router = createRouter(reusable, routes, {
    history: { location: req.url }
  });
  router.once(({ response }) =&gt; {
    if (response.redirect) {
      res.redirect(301);
      return;
    }
    // otherwise, render
  });
}</code></pre></figure></section></section></article><style data-emotion-css="64fwtw">.css-64fwtw{display:none;}@media only screen and (min-width:751px){.css-64fwtw{background:#efefef;display:block;position:fixed;top:50px;bottom:0px;overflow:auto;-webkit-flex:0 0;-ms-flex:0 0;flex:0 0;-webkit-order:-1;-ms-flex-order:-1;order:-1;padding:25px;margin-right:25px;}}</style><div class="css-64fwtw e1hcridg2"><style data-emotion-css="gnbpx8">.css-gnbpx8{width:200px;padding:0;margin:0;}.css-gnbpx8 p{margin:0;}.css-gnbpx8 a{-webkit-text-decoration:none;text-decoration:none;display:block;}.css-gnbpx8 ol{padding-left:0;margin-top:0;list-style-type:none;}.css-gnbpx8 ol ol{padding-left:15px;font-size:0.9em;}</style><menu class="css-gnbpx8 e1evhjzy0"><ol><li><a href="#reuse">Reusing Code</a></li><li><a href="#framework">Web Framework</a></li><li><a href="#request-matching">Request Matching</a><ol><li><a href="#client-side-routes">Client-Side Routes</a></li><li><a href="#static-assets">Static Assets</a></li><li><a href="#path-order">Path Order</a></li></ol></li><li><a href="#handler">Render Handler</a></li><li><a href="#router">Router</a><ol><li><a href="#history">History</a></li><li><a href="#routes">Routes</a></li></ol></li><li><a href="#handling-response">Handling the Response</a><ol><li><a href="#redirect-responses">Redirect Responses</a></li></ol></li></ol></menu></div></div></main></div>
    <script src="https://unpkg.com/react@16.8.6/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16.8.6/umd/react-dom.production.min.js"></script>
    <script src="/static/js/highlight.js"></script>
    <script src="/static/js/bundle.js"></script>
  </body>
</html>
