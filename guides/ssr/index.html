<!doctype html>
<html lang="en" class="font-serif text-small-screen md:text-regular-screen font-light m-0 box-border">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="Cover the basics of server-side rendering an application with Curi">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Server-Side Rendering Guide | Curi Documentation</title>
    <link href="https://fonts.googleapis.com/css?family=Zilla+Slab:300,400" rel="stylesheet">
    <link href="/static/css/prism.css" rel="stylesheet">
    <link href="/static/index.css" rel="stylesheet">
  </head>
  <body>
    <div id="root"><header class="hidden md:block w-screen max-w-full bg-purple p-0 fixed z-10"><nav class="text-gray-100"><ul role="menubar" class="flex flex-row flex-wrap items-end p-0 m-0 max-w-full"><li class="p-0 pr-2 pl-0"><a class=" text-gray-100 text-xl no-underline h-10 flex items-center px-2 border-0 border-b-2 border-purple hover:text-bright-orange md:text-2xl md:text-bright-orange" href="/">Curi</a></li><li class="p-0 pr-2 pl-0" aria-haspopup="true"><a class=" text-gray-100 text-xl no-underline h-10 flex items-center px-2 border-0 border-b-2 border-purple hover:text-bright-orange " href="/v2/">API</a><div class="hidden absolute w-screen left-0 text-purple border-0 border-b-2 border-purple"><ul class="flex flex-row flex-no-wrap justify-start bg-light-blue list-none m-0 p-0"><li><menu class="my-0 mx-5"><h3>router</h3><ul><li><a class=" " href="/v2/@curi/router/">router</a></li><li><a class=" " href="/v2/@curi/interactions/">interactions</a></li></ul></menu></li><li><menu class="my-0 mx-5"><h3>render</h3><ul><li><a class=" " href="/v2/@curi/react-dom/">react-dom</a></li><li><a class=" " href="/v2/@curi/react-native/">react-native</a></li><li><a class=" " href="/v2/@curi/svelte/">svelte</a></li><li><a class=" " href="/v2/@curi/vue/">vue</a></li></ul></menu></li><li><menu class="my-0 mx-5"><h3>other</h3><ul><li><a class=" " href="/v2/@curi/static/">static</a></li><li><a class=" " href="/v2/@curi/helpers/">helpers</a></li><li><a class=" " href="/v2/@curi/types/">types</a></li></ul></menu></li></ul></div></li><li class="p-0 pr-2 pl-0" aria-haspopup="true"><a class="text-bright-orange border-bright-orange text-gray-100 text-xl no-underline h-10 flex items-center px-2 border-0 border-b-2 border-purple hover:text-bright-orange " href="/guides/">Guides</a><div class="hidden absolute w-screen left-0 text-purple border-0 border-b-2 border-purple"><ul class="flex flex-row flex-no-wrap justify-start bg-light-blue list-none m-0 p-0"><menu class="my-0 mx-5"><h3>basic</h3><ul><li><a class=" " href="/guides/installation/">Installation</a></li><li><a class=" " href="/guides/getting-started/">Getting Started</a></li><li><a class=" " href="/guides/history/">History</a></li><li><a class=" " href="/guides/routes/">Routes</a></li><li><a class=" " href="/guides/responses/">Responses</a></li><li><a class=" " href="/guides/navigation-objects/">Navigation Objects</a></li><li><a class=" " href="/guides/sync-or-async/">Sync or Async</a></li><li><a class=" " href="/guides/new-responses/">New Responses</a></li><li><a class=" " href="/guides/accessibility/">Accessibility</a></li></ul></menu><menu class="my-0 mx-5"><h3>rendering</h3><ul><li><a class=" " href="/guides/react-dom/">React DOM</a></li><li><a class=" " href="/guides/react-native/">React Native</a></li><li><a class=" " href="/guides/svelte/">Svelte</a></li><li><a class=" " href="/guides/vue/">Vue</a></li></ul></menu><menu class="my-0 mx-5"><h3>advanced</h3><ul><li><a class=" " href="/guides/route-interactions/">Route Interactions</a></li><li><a class=" " href="/guides/side-effects/">Side Effects</a></li><li><a class=" " href="/guides/code-splitting/">Code Splitting</a></li><li><a class=" " href="/guides/loading/">Loading Route Data</a></li><li><a class="font-bold " href="/guides/ssr/">Server-Side Rendering</a></li><li><a class=" " href="/guides/apollo/">Apollo Integration</a></li></ul></menu></ul></div></li><li class="p-0 pr-2 pl-0" aria-haspopup="true"><a class=" text-gray-100 text-xl no-underline h-10 flex items-center px-2 border-0 border-b-2 border-purple hover:text-bright-orange " href="/tutorial/">Tutorials</a><div class="hidden absolute w-screen left-0 text-purple border-0 border-b-2 border-purple"><ul class="flex flex-row flex-no-wrap justify-start bg-light-blue list-none m-0 p-0"><menu class="my-0 mx-5"><h3>Basic</h3><ul><li><a class=" " href="/tutorial/react-basics/">React Basics</a></li><li><a class=" " href="/tutorial/vue-basics/">Vue Basics</a></li></ul></menu><menu class="my-0 mx-5"><h3>Advanced</h3><ul><li><a class=" " href="/tutorial/react-advanced/">React Advanced</a></li></ul></menu></ul></div></li><li class="p-0 pr-2 pl-0" aria-haspopup="true"><a class=" text-gray-100 text-xl no-underline h-10 flex items-center px-2 border-0 border-b-2 border-purple hover:text-bright-orange " href="/examples/">Examples</a><div class="hidden absolute w-screen left-0 text-purple border-0 border-b-2 border-purple"><ul class="flex flex-row flex-no-wrap justify-start bg-light-blue list-none m-0 p-0"><menu class="my-0 mx-5"><ul style="margin:0 25px"><li><a class=" " href="/examples/basic/">Basic</a></li><li><a class=" " href="/examples/accessibility/">Focus Management</a></li><li><a class=" " href="/examples/active/">Active Routes</a></li><li><a class=" " href="/examples/async/">Async Routes &amp; Navigation</a></li><li><a class=" " href="/examples/breadcrumbs/">Breadcrumbs</a></li><li><a class=" " href="/examples/confirmation/">Navigation Confirmation</a></li><li><a class=" " href="/examples/redirects/">Redirects</a></li><li><a class=" " href="/examples/multi-body/">Multiple Body Components</a></li><li><a class=" " href="/examples/transitions/">Route Transitions</a></li><li><a class=" " href="/examples/modal/">Modal Content</a></li><li><a class=" " href="/examples/spotify/">Spotify Clone</a></li><li><a class=" " href="/examples/twitch/">Twitch Clone</a></li><li><a class=" " href="/examples/code-splitting/">Code Splitting</a></li><li><a class=" " href="/examples/script-tags/">Script Tags</a></li><li><a class=" " href="/examples/server-rendering/">Server Rendering</a></li><li><a class=" " href="/examples/side-effects/">Side Effects</a></li></ul></menu></ul></div></li><li class="p-0 pr-2 pl-0"><a class="text-gray-100 text-xl no-underline h-10 flex items-center px-2 border-0 border-b-2 border-purple hover:text-bright-orange" href="https://github.com/pshrmn/curi">GitHub</a></li></ul></nav></header><menu class="fixed w-screen h-8 left-0 bottom-0 flex flex-row flex-no-wrap justify-between z-50"><button class="h-8 flex-grow text-xl border-0 bg-button-green md:hidden">Menu</button></menu><menu hidden="" class=" fixed overflow-y-scroll w-screen h-screen bg-gray-100 z-40 p-0 pb-10 md:hidden"><div data-reach-tabs=""><div data-reach-tab-list="" role="tablist"><button data-reach-tab="" role="tab" id="tab:null:0" tabindex="0" aria-selected="true" aria-controls="panel:null:0" data-selected="">Main</button><button data-reach-tab="" role="tab" id="tab:null:1" tabindex="-1" aria-selected="false" aria-controls="panel:null:1">Page</button></div><div data-reach-tab-panels="" class="py-0 px-3"><div data-reach-tab-panel="" role="tabpanel" tabindex="-1" aria-labelledby="tab:null:0" id="panel:null:0"><ul class="my-1 mx-0 p-0 list-none"><li><a class=" home-link" href="/">Curi</a></li><li><ul><li class="mb-3"><button title="Toggle group visibility" class="cursor-pointer text-left w-full bg-transparent border-0 p-0 text-purple"><svg width="25" height="15" viewBox="0 0 25 15" xmlns="http://www.w3.org/2000/svg" class="inline-block"><path d="M2,5 l5,5 l5,-5" fill="none" stroke="black" stroke-width="3"></path></svg>API</button></li></ul></li><li><ul><li class="mb-3"><button title="Toggle group visibility" class="cursor-pointer text-left w-full bg-transparent border-0 p-0 text-purple"><svg width="25" height="15" viewBox="0 0 25 15" xmlns="http://www.w3.org/2000/svg" class="inline-block"><path d="M2,5 l5,5 l5,-5" fill="none" stroke="black" stroke-width="3"></path></svg>Guides</button></li></ul></li><li><ul><li class="mb-3"><button title="Toggle group visibility" class="cursor-pointer text-left w-full bg-transparent border-0 p-0 text-purple"><svg width="25" height="15" viewBox="0 0 25 15" xmlns="http://www.w3.org/2000/svg" class="inline-block"><path d="M2,5 l5,5 l5,-5" fill="none" stroke="black" stroke-width="3"></path></svg>Tutorials</button></li></ul></li><li><ul><li class="mb-3"><button title="Toggle group visibility" class="cursor-pointer text-left w-full bg-transparent border-0 p-0 text-purple"><svg width="25" height="15" viewBox="0 0 25 15" xmlns="http://www.w3.org/2000/svg" class="inline-block"><path d="M2,5 l5,5 l5,-5" fill="none" stroke="black" stroke-width="3"></path></svg>Examples</button></li></ul></li><li><a href="https://github.com/pshrmn/curi">GitHub</a></li></ul></div><div data-reach-tab-panel="" role="tabpanel" tabindex="-1" aria-labelledby="tab:null:1" hidden="" id="panel:null:1"><menu class="max-w-full p-0 m-0"><ol class="my-1 mx-0 p-0 list-none p-0"><li><a class="no-underline" href="#reuse">Reusing Code</a></li><li><a class="no-underline" href="#framework">Web Framework</a></li><li><a class="no-underline" href="#request-matching">Request Matching</a><ol class="my-1 mx-0 p-0 list-none pl-3"><li><a class="no-underline" href="#client-side-routes">Client-Side Routes</a></li><li><a class="no-underline" href="#static-assets">Static Assets</a></li><li><a class="no-underline" href="#path-order">Path Order</a></li></ol></li><li><a class="no-underline" href="#handler">Render Handler</a></li><li><a class="no-underline" href="#router">Router</a><ol class="my-1 mx-0 p-0 list-none pl-3"><li><a class="no-underline" href="#history">History</a></li><li><a class="no-underline" href="#routes">Routes</a></li></ol></li><li><a class="no-underline" href="#handling-response">Handling the Response</a><ol class="my-1 mx-0 p-0 list-none pl-3"><li><a class="no-underline" href="#redirect-responses">Redirect Responses</a></li></ol></li></ol></menu></div></div></div></menu><main tabindex="-1" class="w-screen max-w-full pt-3 px-3 pb-0 mb-10 md:pt-10 md:px-0 md:mb-0"><div class="relative md:flex md:flex-row md:flex-no-wrap md:max-w-full"><div class="hidden md:block md:w-64 md:bg-gray-100 md:fixed md:bottom-0 md:overflow-auto md:flex-grow-0 md:flex-shrink-0 md:p-6 md:mr-6" style="top:2rem"><menu class="max-w-full p-0 m-0"><ol class="my-1 mx-0 p-0 list-none p-0"><li><a class="no-underline" href="#reuse">Reusing Code</a></li><li><a class="no-underline" href="#framework">Web Framework</a></li><li><a class="no-underline" href="#request-matching">Request Matching</a><ol class="my-1 mx-0 p-0 list-none pl-3"><li><a class="no-underline" href="#client-side-routes">Client-Side Routes</a></li><li><a class="no-underline" href="#static-assets">Static Assets</a></li><li><a class="no-underline" href="#path-order">Path Order</a></li></ol></li><li><a class="no-underline" href="#handler">Render Handler</a></li><li><a class="no-underline" href="#router">Router</a><ol class="my-1 mx-0 p-0 list-none pl-3"><li><a class="no-underline" href="#history">History</a></li><li><a class="no-underline" href="#routes">Routes</a></li></ol></li><li><a class="no-underline" href="#handling-response">Handling the Response</a><ol class="my-1 mx-0 p-0 list-none pl-3"><li><a class="no-underline" href="#redirect-responses">Redirect Responses</a></li></ol></li></ol></menu></div><article class="md:ml-64 md:pl-8"><section class="mt-3 md:max-w-2xl "><h1 class="outline-none" tabindex="-1">Server-Side Rendering</h1><p class="m-0 mb-4 text-base md:text-lg ">Server-side rendering (SSR) is used to generate the HTML for pages when the server receives a request for them. While not strictly necessary for single-page applications, server-side rendering can potentially be beneficial by:</p><ol><li>Speeding up the initial render time.</li><li>Making it easier for web crawlers to view the application&#x27;s content (which <em>may</em> improve SEO).</li></ol><p class="m-0 mb-4 text-base md:text-lg ">This guide will cover how to setup server-side rendering and some of the issues that you may run into.</p></section><section class="mt-3 md:max-w-2xl"><h2 id="reuse" class="hash-anchor-fix outline-none" tabindex="-1"><a class="header-link no-underline" href="#reuse">Reusing Code</a></h2><p class="m-0 mb-4 text-base md:text-lg ">Being able to reuse code on the client and server is one of the benefits of JavaScript. If you are using syntax in your client-side code that Node doesn&#x27;t know how to parse, such as import/export or JSX, you may run into issues.</p><p class="m-0 mb-4 text-base md:text-lg ">The <a href="https://babeljs.io/">Babel</a> package<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">@babel/node</code> lets Babel compile your code on the fly to syntax that Node understands. Anywhere that you would call<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">node &lt;command&gt;</code>, you should call<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">babel-node &lt;command&gt;</code> instead.</p><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-bash md:whitespace-pre-wrap">npm install --save-dev @babel/node</code></pre></figure><aside class="py-2 px-1 my-1 mx-0 border-gray-300 bg-light-orange border-bright-orange"><strong>Warning:</strong> <p class="m-0 mb-4 text-base md:text-lg "><code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">@babel/node</code> should only be used in development. For production, the server&#x27;s modules should be pre-compiled (using Babel).</p></aside></section><section class="mt-3 md:max-w-2xl"><h2 id="framework" class="hash-anchor-fix outline-none" tabindex="-1"><a class="header-link no-underline" href="#framework">Web Framework</a></h2><p class="m-0 mb-4 text-base md:text-lg ">In order to render JavaScript on the server, you will need to use Node. This guide will be using the<!-- --> <a href="https://expressjs.com/">Express</a> web framework.</p><aside class="py-2 px-1 my-1 mx-0 border-gray-300 bg-gray-200"><strong>Note:</strong> <p class="m-0 mb-4 text-base md:text-lg ">There are ways to mix Node server-side rendering with non-Node frameworks, but that is outside the scope of this guide.</p></aside><p class="m-0 mb-4 text-base md:text-lg ">Familiarity with Express is not expected, so to get you started, this guide will provide some code snippets for a basic setup.</p><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-bash md:whitespace-pre-wrap">npm install express</code></pre></figure><p class="m-0 mb-4 text-base md:text-lg ">The server&#x27;s setup code can be placed anywhere, but we will follow Node&#x27;s convention and save it in a <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">server.js</code> file.</p><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">// server.js
let express = require(&quot;express&quot;);

let app = express();

// ...

app.listen(&quot;8080&quot;, () =&gt; {
  console.log(&quot;Server is running.&quot;);
});</code></pre></figure><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-bash md:whitespace-pre-wrap"># tell node to start the server
# (development only!)
babel-node server.js</code></pre></figure><p class="m-0 mb-4 text-base md:text-lg ">With the server ready to go, we can start configuring it to render a single-page application.</p></section><section class="mt-3 md:max-w-2xl"><h2 id="request-matching" class="hash-anchor-fix outline-none" tabindex="-1"><a class="header-link no-underline" href="#request-matching">Request Matching</a></h2><p class="m-0 mb-4 text-base md:text-lg ">A web framework receives requests from the client and returns responses.</p><p class="m-0 mb-4 text-base md:text-lg ">In the client-side application, we define the routes that are valid for the application. Similarly, the server needs to define which request paths are valid so that it can properly respond to them.</p><p class="m-0 mb-4 text-base md:text-lg ">Server paths are given handler functions. These can do a variety of things, but we will only be using them to send responses.</p><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">app.use(&quot;/hi&quot;, function(req, res) {
  res.send(&quot;Hey!&quot;);
})</code></pre></figure><section class="mt-3 md:max-w-2xl"><h3 id="client-side-routes" class="hash-anchor-fix outline-none" tabindex="-1"><a class="header-link no-underline" href="#client-side-routes">Client-Side Routes</a></h3><p class="m-0 mb-4 text-base md:text-lg ">Instead of telling the server about every single valid client-side route, a wildcard path is used to match every request. Determining what to render for the request will be done by Curi.</p><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">// the wildcard matches every GET request
app.get(&quot;*&quot;, renderHandler);</code></pre></figure><aside class="py-2 px-1 my-1 mx-0 border-gray-300 bg-gray-200"><strong>Note:</strong> <p class="m-0 mb-4 text-base md:text-lg ">The <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">*</code> wildcard handler is similar to the Curi path<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">(.*)</code>. Express and Curi both use<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">path-to-regexp</code> for path matching. However, Express uses an old version. <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">path-to-regexp</code> removed support for the barebones <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">*</code> pattern in the version that Curi uses, which is why we have to use <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">(.*)</code> in Curi routes.</p></aside></section><section class="mt-3 md:max-w-2xl"><h3 id="static-assets" class="hash-anchor-fix outline-none" tabindex="-1"><a class="header-link no-underline" href="#static-assets">Static Assets</a></h3><p class="m-0 mb-4 text-base md:text-lg ">Page requests aren&#x27;t the only requests that the framework will handle. Requests for static resources, like scripts, stylesheet, and images shouldn&#x27;t be handled by Curi. Express provides a<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">static</code> method to map request locations &quot;real&quot; (files exist on the server) locations.</p><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">app.use(&quot;/static&quot;, express.static());</code></pre></figure><p class="m-0 mb-4 text-base md:text-lg ">Using the above static file handler, all static file requests in HTML/JavaScript should begin with <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">/static</code>.</p><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-html md:whitespace-pre-wrap">&lt;img src=&quot;/static/img/circle.png&quot; /&gt;</code></pre></figure></section><section class="mt-3 md:max-w-2xl"><h3 id="path-order" class="hash-anchor-fix outline-none" tabindex="-1"><a class="header-link no-underline" href="#path-order">Path Order</a></h3><p class="m-0 mb-4 text-base md:text-lg ">Express matches against paths in the order that they are registered, so the static files path needs to be defined before the wildcard path.</p><p class="m-0 mb-4 text-base md:text-lg ">Any other non-page paths, like APIs, would also need to be defined before the catch-all.</p><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">app.use(&quot;/static&quot;, express.static());
app.use(&quot;/api&quot;, dataHandler);
app.get(&quot;*&quot;, renderHandler);</code></pre></figure></section></section><section class="mt-3 md:max-w-2xl"><h2 id="handler" class="hash-anchor-fix outline-none" tabindex="-1"><a class="header-link no-underline" href="#handler">Render Handler</a></h2><p class="m-0 mb-4 text-base md:text-lg ">The render handler function receives the request object and a response object. The response object is used to build and send a response to the user.</p><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">// renderer.js
function renderHandler(req, res) {

}

// server.js
let renderHandler = require(&quot;./renderer&quot;);

app.get(&quot;*&quot;, renderHandler)</code></pre></figure><aside class="py-2 px-1 my-1 mx-0 border-gray-300 bg-gray-200"><strong>Note:</strong> <p class="m-0 mb-4 text-base md:text-lg ">If you are setting up a server without server-side rendering, the<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">renderHandler</code> function could use <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">res.sendFile</code> <!-- -->to return a universal HTML file for every route.</p></aside><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">let index = path.join(__dirname, &quot;public&quot;, &quot;index.html&quot;);

function renderHandler(req, res) {
  res.sendFile(index);
}</code></pre></figure></section><section class="mt-3 md:max-w-2xl"><h2 id="router" class="hash-anchor-fix outline-none" tabindex="-1"><a class="header-link no-underline" href="#router">Router</a></h2><p class="m-0 mb-4 text-base md:text-lg ">A router instance will be created for every single request. The router will match the requested location to its routes and generate a response, which can be used to render the HTML.</p><p class="m-0 mb-4 text-base md:text-lg ">Curi has two optimizations to make this more efficient:</p><ol><li>By wrapping the routes array in a <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">prepareRoutes</code> call, all of an application&#x27;s routes are pre-compiled. Without<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">prepareRoutes</code>, the route pathes would need to be re-compiled for every request!</li><li>We will use a lightweight history type created specifically for server-side rendering.</li></ol><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">// renderer.js
import { createRouter } from &quot;@curi/router&quot;;
import { createReusable } from &quot;@hickory/in-memory&quot;;

let reusable = createReusable();

function handler(req, res) {
  let router = createRouter(reusable, routes, {
    history: { location: req.url }
  });
  router.once(({ response }) =&gt; {
    // render the response
  })
}</code></pre></figure><section class="mt-3 md:max-w-2xl"><h3 id="history" class="hash-anchor-fix outline-none" tabindex="-1"><a class="header-link no-underline" href="#history">History</a></h3><p class="m-0 mb-4 text-base md:text-lg ">On the client-side, a single-page application uses<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">@hickory/browser</code> to create a history instance. However, that uses browser only APIs. On the server, the<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">@hickory/in-memory</code> package is used to create a history instance that only exists in memory.</p><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-bash md:whitespace-pre-wrap">npm install @hickory/in-memory</code></pre></figure><p class="m-0 mb-4 text-base md:text-lg ">The server doesn&#x27;t need a fully functional history object. Instead, the server only needs a history object that knows its location and how to generate URLs.</p><p class="m-0 mb-4 text-base md:text-lg ">The <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">createReusable</code> function exported by<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">@hickory/in-memory</code> is made specifically for this job.<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">createReusable</code> takes history options and returns a history function.</p><p class="m-0 mb-4 text-base md:text-lg "><code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">createReusable</code> creates internal functions for location parsing/stringifying ahead of time so that they don&#x27;t need to be recreated for every request.</p><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">// handler.js
import { createRouter } from &quot;@curi/router&quot;;
import { createReusable } from &quot;@hickory/in-memory&quot;;

let reusable = createReusable();</code></pre></figure><p class="m-0 mb-4 text-base md:text-lg ">When creating the router, we must pass a <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">history</code> option with the location of the request.</p><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">function handler(req, res) {
  let router = createRouter(reusable, routes, {
    history: { location: req.url }
  });
  // ...
}</code></pre></figure></section><section class="mt-3 md:max-w-2xl"><h3 id="routes" class="hash-anchor-fix outline-none" tabindex="-1"><a class="header-link no-underline" href="#routes">Routes</a></h3><p class="m-0 mb-4 text-base md:text-lg ">As stated above, the <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">prepareRoutes</code> function is used to pre-compile routes, which means that they don&#x27;t end up being re-compiled for every single request. If all of an application&#x27;s routes are synchronous (they don&#x27;t use <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">route.resolve</code>), then they don&#x27;t need to do anything else for server-side rendering.</p><p class="m-0 mb-4 text-base md:text-lg ">Ideally, you will be able to re-use your client side routes on the server, but if the client routes use browser only APIs, you may need to adapt the routes to work on the server.</p><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">// handler.js
import routes from &quot;../client/routes&quot;;</code></pre></figure><p class="m-0 mb-4 text-base md:text-lg ">One approach to client/server routes is to keep two copies: one for the client and one for the server. However, this should be a last resort because it can lead to inconsistencies if you update one file but not the other.</p><p class="m-0 mb-4 text-base md:text-lg ">A more reusable approach would be to use &quot;universal&quot; wrappers around any environment specific APIs. For example, the<!-- --> <a href="https://github.com/matthew-andrews/isomorphic-fetch"><code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">isomorphic-fetch</code></a> <!-- -->package could be used to support <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">fetch</code> in the browser and Node.</p><figure class="m-0 mb-4"><pre class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">// routes.js
import fetch from &quot;isomorphic-fetch&quot;;
import { prepareRoutes } from &quot;@curi/router&quot;;

export default prepareRoutes([
  {
    name: &quot;Test&quot;,
    path: &quot;test&quot;,
    resolve() {
      return fetch(&quot;/test-data&quot;);
    }
  }
]);</code></pre></figure></section></section><section class="mt-3 md:max-w-2xl"><h2 id="handling-response" class="hash-anchor-fix outline-none" tabindex="-1"><a class="header-link no-underline" href="#handling-response">Handling the Response</a></h2><p class="m-0 mb-4 text-base md:text-lg ">When the router is created, it will start generating a response by matching its <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">history</code> object&#x27;s current location. If the application has any asynchronous routes, the <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">response</code> may not be ready immediately. The safest approach is to use<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">router.once</code> to wait for the <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">response</code>.</p><figure class="m-0 mb-4"><pre data-line="5-7" class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">function renderHandler(req, res) {
  let router = createRouter(reusable, routes, {
    history: { location: req.url }
  });
  router.once(({ response }) =&gt; {
    // ...
  });
}</code></pre></figure><p class="m-0 mb-4 text-base md:text-lg ">Once the response is generated, we are ready to render. This step will generate the HTML string for the application. How exactly you do this depends on what UI renderer you are using, but the process is approximately the same for most renderering libraries.</p><p class="m-0 mb-4 text-base md:text-lg ">Here, we will assume that you are using React. The<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">react-dom/server</code> module provides a<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">renderToString</code> method, which will render an application as a string.</p><p class="m-0 mb-4 text-base md:text-lg ">Rendering with React on the server is essentially the same as rendering on the client. We create a <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">Router</code> and use<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">renderToString</code> (instead of <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">ReactDOM.render</code>) to render the component.</p><figure class="m-0 mb-4"><pre data-line="1-2,9-14" class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">import { renderToString } from &quot;react-dom/server&quot;;
import { createRouterComponent } from &quot;@curi/react-dom&quot;;

function renderHandler(req, res) {
  let router = createRouter(reusable, routes, {
    history: { location: req.url }
  });
  router.once(({ response }) =&gt; {
    let Router = createRouterComponent(router);
    let markup = renderToString(
      &lt;Router&gt;
        &lt;App /&gt;
      &lt;/Router&gt;
    );
  });
}</code></pre></figure><p class="m-0 mb-4 text-base md:text-lg ">Rendering with <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">renderToString</code> only generates an HTML string for the application. We are missing the <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">&lt;<!-- -->html<!-- -->&gt;</code>,<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">&lt;<!-- -->head<!-- -->&gt;</code>,<code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">&lt;<!-- -->body<!-- -->&gt;</code>, <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">&lt;<!-- -->script<!-- -->&gt;</code>, etc. tags that are required for the full HTML page to properly function.</p><p class="m-0 mb-4 text-base md:text-lg ">We can write a function that takes the string created by<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">renderToString</code>and inserts it into the full HTML string for a page.</p><p class="m-0 mb-4 text-base md:text-lg ">For a React application, the markup string should be set as the child of its container element. If you render into the <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">#root</code> <!-- -->element on the client, the HTML should have a <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">#root</code> <!-- -->element.</p><p class="m-0 mb-4 text-base md:text-lg ">Any JavaScript scripts that need to be rendered should also be included in the HTML. Make sure that their paths are absolute; if the path is relative, then you will run into errors resolving the location for nested routes!</p><p class="m-0 mb-4 text-base md:text-lg ">The <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">meta</code> property of a <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">response</code> is useful for server-side rendering. For example, routes can set<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">meta.title</code> to be the page&#x27;s title, which can be inserted into the generated HTML.</p><figure class="m-0 mb-4"><pre data-line="4-15,28-29" class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">import { renderToString } from &quot;react-dom/server&quot;;
import { createRouterComponent } from &quot;@curi/react-dom&quot;;

function insertMarkup(markup, title) {
  return `&lt;!doctype html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;${title} | My Site&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;root&quot;&gt;${markup}&lt;/div&gt;
    &lt;script src=&quot;/static/js/bundle.js&quot;&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;`;
}

function renderHandler(req, res) {
  let router = createRouter(reusable, routes, {
    history: { location: req.url }
  });
  router.once(({ response }) =&gt; {
    let Router = createRouterComponent(router);
    let markup = renderToString(
      &lt;Router&gt;
        &lt;App /&gt;
      &lt;/Router&gt;
    );
    let html = insertMarkup(markup, response.meta.title);
    res.send(html);
  });
}</code></pre></figure><aside class="py-2 px-1 my-1 mx-0 border-gray-300 bg-gray-200"><strong>Note:</strong> <p class="m-0 mb-4 text-base md:text-lg ">If you server render a React application, you should use<!-- --> <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">ReactDOM.hydrate</code> instead of <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">ReactDOM.render</code> on the client.</p></aside><section class="mt-3 md:max-w-2xl"><h3 id="redirect-responses" class="hash-anchor-fix outline-none" tabindex="-1"><a class="header-link no-underline" href="#redirect-responses">Redirect Responses</a></h3><p class="m-0 mb-4 text-base md:text-lg ">If a route matches and it redirects, you can handle it without rendering the application. A <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">response</code> is a redirect if it has a <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">redirect</code> property. <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">redirect.url</code> is that full URL (<code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">pathname</code>, <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">query</code>, and <code class=" p-1 rounded whitespace-normal background-white text-purple" style="text-shadow:none">hash</code>).</p><figure class="m-0 mb-4"><pre data-line="9-12" class="align-top h-full whitespace-pre-wrap"><code class="language-javascript md:whitespace-pre-wrap">import { renderToString } from &quot;react-dom/server&quot;;
import { createRouterComponent } from &quot;@curi/react-dom&quot;;

function renderHandler(req, res) {
  let router = createRouter(reusable, routes, {
    history: { location: req.url }
  });
  router.once(({ response }) =&gt; {
    if (response.redirect) {
      res.redirect(301);
      return;
    }
    // otherwise, render
  });
}</code></pre></figure></section></section></article></div></main></div>
    <script src="https://unpkg.com/react@16.13.1/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16.13.1/umd/react-dom.production.min.js"></script>
    <script src="/static/js/highlight.js"></script>
    <script src="/static/js/bundle.js"></script>
  </body>
</html>
